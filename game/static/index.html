<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Get Article From Medium!</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Import style -->
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css"/>
    <!-- Import Vue 3 -->
    <script src="//unpkg.com/vue@3"></script>
    <!-- Import component library -->
    <script src="//unpkg.com/element-plus"></script>
</head>
<body>
<div id="app">
    <div style="width: 80%;margin: auto;">

        <el-card class="box-card">
            <template #header>
                <div class="card-header">
                    <span>Get Article From Medium!</span>
                </div>
            </template>
            <div>
                <el-form label-width="120px">
                    <el-form-item label="获取标题数量">
                        <el-slider v-model="size" show-input :max="1000"/>
                    </el-form-item>
                    <el-form-item>
                        <el-checkbox :disabled="priStatus" v-model="pri" label="获取未公开的" size="large"/>
                    </el-form-item>
                    <el-form-item>
                        <el-button type="primary" v-on:click="getArticles" round :loading="loadingGetArticles">
                            {{getArticlesText}}
                        </el-button>
                        <el-button v-on:click="download" :disabled="downloadStatus"  round>Download</el-button>
                    </el-form-item>
                    <el-form-item>
                        <el-alert title="0代表不从网站上获取标题，使用本地数据库的数据" type="info"/>
                    </el-form-item>
                </el-form>
                <!--                article_id":article_id,"title":title,"author":name,"url":url,"clap":clap_count,"locked":locked}-->
                <p v-for="item in top10" :key="item.article_id">
                    <el-link :href="item.url" target="_blank">{{item.title}}</el-link>
                    <el-text class="mx-1">&nbsp;&nbsp;&nbsp;&nbsp;(clap:{{item.clap}})&nbsp;&nbsp;&nbsp;&nbsp;</el-text>
                    <el-text v-if="item.locked===1" class="mx-1" type="danger">(locked)</el-text>
                    <el-text v-if="item.locked===0" class="mx-1" type="success">(unlocked)</el-text>
                </p>
            </div>
        </el-card>
    </div>
</div>
<script>
    const App = {
        data() {
            return {
                size: 500,
                top10: [],
                taskID: null,
                loadingGetArticles: false,
                getArticlesText: "Create pdf files",
                pri: false,
                priStatus: false,
                downloadStatus:true
            };
        },
        computed: {
            // 一个计算属性的 getter
            locked() {
                // `this` 指向当前组件实例
                return this.pri === false ? '0' : '0|1'
            }
        },
        beforeDestroy() {
            this.stopPolling(); // 在组件销毁前清除定时器
        },
        methods: {
            getArticles() {
                fetch('/get_articles?size=' + this.size + "&" + "locked=" + this.locked, {
                    method: 'GET',
                })
                    .then(response => response.json())
                    .then(data => {
                        //取到taskID
                        taskID = data['task_id'];
                        this.taskID = taskID
                        //根据id轮询
                        this.loadingGetArticles = true;
                        this.getArticlesText = "Getting..."
                        this.priStatus = true
                        this.downloadStatus=true
                        this.startPolling()
                    })
                    .catch((error) => console.error('Error:', error));
            },
            queryTask() {
                fetch("/task/" + this.taskID, {method: 'GET'})
                    .then(response => response.json())
                    .then(data => {
                        data = data['data']
                        if (data[1] == 1 || data[1] == 2) {
                            this.stopPolling();
                            this.loadingGetArticles = false;
                            this.getArticlesText = "Create pdf files"
                            this.downloadStatus=false
                            this.priStatus = false
                        }
                    })
                    .catch((error) => console.error('Error:', error));
                this.queryTop10()
            },
            queryTop10() {
                fetch("/top_10_articles?locked=" + this.locked, {method: 'GET'})
                    .then(response => response.json())
                    .then(data => {
                        this.top10 = data['data']
                    })
                    .catch((error) => console.error('Error:', error));
            },
            download() {
                fetch("/download", {method: 'GET'})
                    .then(response => response.json())
                    .then(data => {
                        if(data.message=="请先获取！"){
                            this.$message.error('请先创建pdf！');
                        }else {
                            var path=data.data
                            window.open(path,"_blank");
                        }
                        console.log(data)
                    })
                    .catch((error) => console.error('Error:', error));
            },
            startPolling() {
                this.timer = setInterval(this.queryTask, 500);
            },
            stopPolling() {
                clearInterval(this.timer);
                this.timer = null;
            }
        }
    };

    const app = Vue.createApp(App);
    app.use(ElementPlus);
    app.mount("#app");
</script>
</body>
</html>